<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C√¥ng c·ª• HD SaiSon</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
        font-family: Roboto;
      }
      body {
        background: #f0f4f8;
        padding-top: 56px;
      }

      #loginScreen {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #007bff, #00c6ff);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .login-box {
        background: #fff;
        padding: 30px;
        width: 320px;
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        text-align: center;
      }

      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 56px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        z-index: 1000;
      }
      .logo {
        font-weight: 700;
        color: #007bff;
      }
      .desktop-nav a {
        margin-left: 15px;
        font-size: 14px;
        text-decoration: none;
        color: #333;
      }
      @media (max-width: 768px) {
        .desktop-nav {
          display: none;
        }
      }

      .container-custom {
        max-width: 520px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      input {
        text-align: right;
        font-size: 16px;
        padding: 12px;
      }
      label {
        font-weight: 500;
      }

      .result {
        margin-top: 20px;
        padding: 15px;
        background: #e7f3ff;
        border-left: 5px solid #007bff;
        border-radius: 12px;
      }

      .plan-box {
        background: #fff;
        border-radius: 14px;
        padding: 14px;
        margin-bottom: 12px;
        border: 1px solid #e3eaf3;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: relative;
        cursor: pointer;
        transition: 0.25s;
      }
      .plan-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
      }
      .plan-row .value {
        font-weight: 600;
        color: #0d47a1;
      }
      .plan-row.total .value {
        color: #e53935;
        font-weight: 700;
      }
      .divider {
        height: 1px;
        background: #e0e0e0;
        margin: 8px 0;
      }

      .plan-box.active {
        border: 3px solid #ff9800 !important;
        background: #fff3e0;
        box-shadow: 0 6px 18px rgba(255, 152, 0, 0.4);
      }
      .plan-box.active::after {
        content: "üëâ ƒêANG CH·ªåN";
        position: absolute;
        top: -10px;
        left: 10px;
        background: #ff9800;
        color: #fff;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
      }

      .list-group button {
        font-size: 14px;
        text-align: left;
      }
    </style>
  </head>

  <body>
    <div id="loginScreen">
      <div class="login-box">
        <h4>üîê ƒêƒÉng nh·∫≠p</h4>
        <input
          id="loginKey"
          type="password"
          class="form-control mb-3"
          placeholder="Nh·∫≠p kho√°"
        />
        <button class="btn btn-primary w-100" onclick="login()">
          X√°c nh·∫≠n
        </button>
        <p id="loginError" class="text-danger mt-2"></p>
      </div>
    </div>

    <header>
      <div class="logo">üöó Batch 41</div>
      <nav class="desktop-nav">
        <a href="./index.html">T√≠nh tr·∫£ g√≥p</a>
        <a href="./check_old.html">T√≠nh tu·ªïi</a>
        <a href="./cancel_contract.html">Hu·ª∑ Hƒê</a>
        <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
      </nav>
    </header>

    <div class="container-custom mt-3">
      <h5 class="text-center">T√çNH TR·∫¢ G√ìP XE</h5>

      <label>Gi√° xe</label>
      <input id="giaXe" class="form-control mb-3" oninput="onGiaXeChange()" />
      <div id="suggestGiaXe" class="list-group mb-2"></div>

      <label>Tr·∫£ tr∆∞·ªõc (VNƒê)</label>
      <input
        id="traTien"
        class="form-control mb-3"
        oninput="onTraTienChange()"
      />
      <div id="suggestTraTien" class="list-group mb-2"></div>

      <label>Tr·∫£ tr∆∞·ªõc (%)</label>
      <input
        id="traPercent"
        class="form-control mb-2"
        oninput="onTraPercentChange()"
      />

      <div class="d-flex gap-2 mb-3">
        <button
          class="btn btn-outline-secondary w-100"
          onclick="setPercent(20)"
        >
          20%
        </button>
        <button
          class="btn btn-outline-secondary w-100"
          onclick="setPercent(30)"
        >
          30%
        </button>
        <button
          class="btn btn-outline-secondary w-100"
          onclick="setPercent(40)"
        >
          40%
        </button>
      </div>

      <!-- Dynamic package buttons -->
      <div id="packageButtons" class="d-flex gap-2 mb-3"></div>

      <div id="result" class="result" style="display: none"></div>
      <button class="btn btn-warning w-100 mt-2" onclick="openExportModal()">
        üì∏ Xu·∫•t ·∫£nh g·ª≠i Zalo
      </button>
    </div>

    <!-- EXPORT MODAL -->
    <div class="modal fade" id="exportModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 16px">
          <div class="modal-header">
            <h5 class="modal-title">üìÑ Th√¥ng tin xu·∫•t ·∫£nh</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Lo·∫°i xe</label>
                <input
                  type="text"
                  id="modalLoaiXe"
                  class="form-control text-uppercase"
                  oninput="forceUpper(this)"
                  placeholder="VD: SH 160I ABS"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">M√†u s∆°n (gi√° tr·ªã s·ªë)</label>
                <input
                  type="text"
                  id="modalMauSon"
                  class="form-control"
                  oninput="formatNumberInput(this)"
                  placeholder="VD: 1500000"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Gi·∫•y t·ªù (gi√° tr·ªã s·ªë)</label>
                <input
                  type="text"
                  id="modalGiayTo"
                  class="form-control"
                  oninput="formatNumberInput(this)"
                  placeholder="VD: 800000"
                />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Hu·ª∑
            </button>
            <button class="btn btn-warning" onclick="confirmExport()">
              Xu·∫•t ·∫£nh
            </button>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>
      const ACCESS_KEY = "B41";
      const $ = (id) => document.getElementById(id);

      function login() {
        if ($("loginKey").value === ACCESS_KEY) {
          $("loginScreen").style.display = "none";
          sessionStorage.setItem("logged", "1");
        } else $("loginError").innerText = "Sai kho√°";
      }

      function forceUpper(el) {
        el.value = el.value.toUpperCase();
      }

      function formatNumberInput(el) {
        let value = el.value.replace(/\D/g, ""); // ch·ªâ cho s·ªë
        el.value = Number(value).toLocaleString("vi-VN");
      }

      function logout() {
        sessionStorage.clear();
        location.reload();
      }

      const HE_SO = {
        0.89: {
          9: 0.12517,
          12: 0.09723,
          15: 0.08049,
          18: 0.06936,
          21: 0.06143,
          24: 0.05548,
        },
        1.21: {
          9: 0.12837,
          12: 0.1004,
          15: 0.08367,
          18: 0.07256,
          21: 0.06465,
          24: 0.05874,
          36: 0.04516,
        },
        1.51: {
          9: 0.131461,
          12: 0.103484,
          15: 0.086765,
          18: 0.075684,
          21: 0.067811,
          24: 0.061945,
          36: 0.048559,
        },
        1.78: {
          9: 0.134079,
          12: 0.106095,
          15: 0.089412,
          18: 0.078378,
          21: 0.070555,
          24: 0.064745,
          36: 0.051548,
        },
      };

      let currentPackage = 1.21,
        lock = false;

      const format = (n) => Number(n).toLocaleString("vi-VN");
      const parse = (v) => parseFloat(String(v).replace(/\./g, "")) || 0;
      const ceil = (n) => Math.ceil(n / 1000) * 1000;
      const formatInput = (el) =>
        (el.value = format(el.value.replace(/\D/g, "")));

      function renderPackageButtons() {
        const container = $("packageButtons");
        container.innerHTML = "";
        Object.keys(HE_SO).forEach((key) => {
          const value = parseFloat(key);
          const btn = document.createElement("button");
          btn.id = "btn_" + key.replace(".", "");
          btn.className =
            value === currentPackage
              ? "btn btn-primary w-100"
              : "btn btn-secondary w-100";
          btn.innerText = key;
          btn.onclick = () => setPackage(value);
          container.appendChild(btn);
        });
      }

      function setPackage(p) {
        currentPackage = p;
        Object.keys(HE_SO).forEach((key) => {
          const btn = $("btn_" + key.replace(".", ""));
          if (!btn) return;
          btn.className =
            parseFloat(key) === p
              ? "btn btn-primary w-100"
              : "btn btn-secondary w-100";
        });
        autoTinh();
      }

      function setPercent(p) {
        $("traPercent").value = p;
        onTraPercentChange();
      }

      function onGiaXeChange() {
        formatInput($("giaXe"));
        genTraTienSuggest();
        autoTinh();
      }

      function onTraTienChange() {
        if (lock) return;
        lock = true;
        formatInput($("traTien"));
        let gia = parse($("giaXe").value);
        if (gia > 0)
          $("traPercent").value = (
            (parse($("traTien").value) / gia) *
            100
          ).toFixed(2);
        lock = false;
        genTraTienSuggest();
        autoTinh();
      }

      function onTraPercentChange() {
        if (lock) return;
        lock = true;
        let gia = parse($("giaXe").value);
        let percent = parseFloat($("traPercent").value || 0);
        $("traTien").value = format(ceil((gia * percent) / 100));
        lock = false;
        genTraTienSuggest();
        autoTinh();
      }

      function genTraTienSuggest() {
        let gia = parse($("giaXe").value);
        if (!gia) return;
        let percentStart = parseFloat($("traPercent").value) || 10;
        let list = [];
        for (let p = percentStart; p <= 80; p += 10) list.push(gia * (p / 100));
        let v = parse($("traTien").value);
        if (v > 0) {
          list.push(Math.round(v / 50000) * 50000);
          list.push(Math.round(v / 100000) * 100000);
        }
        list = [
          ...new Set(
            list
              .map((n) => Math.ceil(n / 10000) * 10000)
              .filter((n) => n > 0 && n < gia),
          ),
        ].sort((a, b) => a - b);
        let box = $("suggestTraTien");
        box.innerHTML = "";
        list.forEach((n) => {
          let percent = ((n / gia) * 100).toFixed(1);
          let btn = document.createElement("button");
          btn.className =
            "list-group-item list-group-item-action d-flex justify-content-between";
          btn.innerHTML = `<span>${format(n)} ƒë</span><span style="color:#007bff;font-weight:600">${percent}%</span>`;
          btn.onclick = () => {
            $("traTien").value = format(n);
            box.innerHTML = "";
            onTraTienChange();
          };
          box.appendChild(btn);
        });
      }

      function autoTinh() {
        let gia = parse($("giaXe").value);
        let tra = parse($("traTien").value);
        if (gia > 0 && tra < gia) tinhTraGop();
        else $("result").style.display = "none";
      }

      function tinhTraGop() {
        let gia = parse($("giaXe").value);
        let tra = parse($("traTien").value);
        let vay = gia - tra;
        let heSo = HE_SO[currentPackage];
        let min = Infinity,
          plans = [];

        Object.entries(heSo).forEach(([t, hs]) => {
          let thang = ceil(vay * hs + 12000);
          let lai = thang * t - vay;
          if (lai < min) min = lai;
          plans.push({ t, thang, lai });
        });

        let html = `
<b>Gi√° xe:</b> ${format(gia)} ƒë<br>
<b>Tr·∫£ tr∆∞·ªõc:</b> ${format(tra)} ƒë<br>
<b>Kho·∫£n vay:</b> ${format(vay)} ƒë<br><br>
`;

        plans.forEach((p) => {
          html += `
<div class="plan-box ${p.lai === min ? "best-plan" : ""}" onclick="selectPlan(this)">
<div class="plan-row"><strong>${p.t} th√°ng</strong></div>
<div class="plan-row"><span>Tr·∫£/th√°ng</span><span class="value">${format(p.thang)} ƒë</span></div>
<div class="divider"></div>
<div class="plan-row total"><span>T·ªïng l√£i</span><span class="value">${format(p.lai)} ƒë</span></div>
</div>`;
        });

        $("result").innerHTML = html;
        $("result").style.display = "block";
      }

      function selectPlan(el) {
        document
          .querySelectorAll(".plan-box")
          .forEach((p) => p.classList.remove("active"));
        el.classList.add("active");
      }

      //     function exportImage() {
      //       let gia = parse($("giaXe").value);
      //       let tra = parse($("traTien").value);
      //       let vay = gia - tra;

      //       if (!gia || !tra || vay <= 0) {
      //         alert("Ch∆∞a c√≥ d·ªØ li·ªáu");
      //         return;
      //       }

      //       // üî• H·ªèi lo·∫°i xe
      //       let loaiXe = prompt("Nh·∫≠p lo·∫°i xe (c√≥ th·ªÉ b·ªè tr·ªëng):");
      //       if (loaiXe === null) loaiXe = ""; // n·∫øu b·∫•m cancel

      //       const heSo = HE_SO[currentPackage];

      //       let plans = {};
      //       Object.entries(heSo).forEach(([t, hs]) => {
      //         let thang = ceil(vay * hs + 12000);
      //         let tongLai = thang * t - vay;

      //         plans[t] = {
      //           thang: format(thang) + " ƒë",
      //           lai: format(tongLai) + " ƒë",
      //         };
      //       });

      //       let exportDiv = document.createElement("div");
      //       exportDiv.style.width = "800px";
      //       exportDiv.style.padding = "40px";
      //       exportDiv.style.background = "#fff";
      //       exportDiv.style.fontFamily = "Times New Roman";
      //       exportDiv.style.color = "#000";
      //       exportDiv.style.lineHeight = "1.8";
      //       exportDiv.style.fontSize = "22px";

      //       exportDiv.innerHTML = `
      //   <h2 style="margin-bottom:20px;">HD SAISON</h2>

      //   ${loaiXe ? `LO·∫†I XE: ${loaiXe}<br>` : ""}
      //   GI√Å XE: ${format(gia)} ƒë<br>
      //   TR·∫¢ TR∆Ø·ªöC: ${format(tra)} ƒë<br>
      //   KHO·∫¢N VAY: ${format(vay)} ƒë<br>
      //   GI·∫§Y T·ªú: ..........................................................<br>
      //   M√ÄU S∆†N: ..........................................................<br><br>

      //   12 th√°ng: ${plans[12] ? plans[12].thang + " | L√£i: " + plans[12].lai : ""}<br>
      //   15 th√°ng: ${plans[15] ? plans[15].thang + " | L√£i: " + plans[15].lai : ""}<br>
      //   18 th√°ng: ${plans[18] ? plans[18].thang + " | L√£i: " + plans[18].lai : ""}<br>
      //   21 th√°ng: ${plans[21] ? plans[21].thang + " | L√£i: " + plans[21].lai : ""}<br>
      //   24 th√°ng: ${plans[24] ? plans[24].thang + " | L√£i: " + plans[24].lai : ""}<br>
      //   36 th√°ng: ${plans[36] ? plans[36].thang + " | L√£i: " + plans[36].lai : ""}<br><br>

      //   <strong>TH·ª¶ T·ª§C: CCCD CHIP + ƒêTDD</strong>
      // `;

      //       document.body.appendChild(exportDiv);

      //       html2canvas(exportDiv).then((canvas) => {
      //         let a = document.createElement("a");
      //         a.href = canvas.toDataURL("image/png");
      //         a.download = "bang-tra-gop-hdsaison.png";
      //         a.click();
      //         document.body.removeChild(exportDiv);
      //       });
      //     }
      function openExportModal() {
        let gia = parse($("giaXe").value);
        let tra = parse($("traTien").value);

        if (!gia || !tra || tra >= gia) {
          alert("Ch∆∞a c√≥ d·ªØ li·ªáu h·ª£p l·ªá");
          return;
        }

        const modal = new bootstrap.Modal(
          document.getElementById("exportModal"),
        );
        modal.show();
      }

      async function confirmExport() {
        let gia = parse($("giaXe").value);
        let tra = parse($("traTien").value);
        let vay = gia - tra;

        const loaiXe = $("modalLoaiXe").value.trim().toUpperCase();
        const mauSon = $("modalMauSon").value || "";
        const giayTo = $("modalGiayTo").value || "";

        const heSo = HE_SO[currentPackage];

        let plans = {};
        Object.entries(heSo).forEach(([t, hs]) => {
          let thang = ceil(vay * hs + 12000);
          let tongLai = thang * t - vay;

          plans[t] = {
            thang: format(thang) + " ƒë",
            lai: format(tongLai) + " ƒë",
          };
        });

        // T·∫°o div t·∫°m ƒë·ªÉ render
        let exportDiv = document.createElement("div");
        exportDiv.style.width = "600px";
        exportDiv.style.padding = "30px";
        exportDiv.style.background = "#fff";
        exportDiv.style.fontFamily = "Times New Roman";
        exportDiv.style.fontSize = "26px";
        exportDiv.style.lineHeight = "1.6";

        exportDiv.innerHTML = `
  <div style="text-align:left;margin-bottom:20px;">
    <img src="./images/logo.png" style="max-width:170px;">
  </div>

  ${loaiXe ? `<b>LO·∫†I XE:</b> ${loaiXe}<br>` : ""}
  <b>GI√Å XE:</b> ${format(gia)} ƒë<br>
  <b>TR·∫¢ TR∆Ø·ªöC:</b> ${format(tra)} ƒë<br>
  <b>KHO·∫¢N VAY:</b> ${format(vay)} ƒë<br>
  ${mauSon ? `<b>M√ÄU S∆†N:</b> ${mauSon} ƒë<br>` : ""}
  ${giayTo ? `<b>GI·∫§Y T·ªú:</b> ${giayTo} ƒë<br>` : ""}
  <hr style="margin:10px 0;">

  12 TH√ÅNG: ${plans[12] ? plans[12].thang + " | L√£i: " + plans[12].lai : ""}<br>
  15 TH√ÅNG: ${plans[15] ? plans[15].thang + " | L√£i: " + plans[15].lai : ""}<br>
  18 TH√ÅNG: ${plans[18] ? plans[18].thang + " | L√£i: " + plans[18].lai : ""}<br>
  21 TH√ÅNG: ${plans[21] ? plans[21].thang + " | L√£i: " + plans[21].lai : ""}<br>
  24 TH√ÅNG: ${plans[24] ? plans[24].thang + " | L√£i: " + plans[24].lai : ""}<br>
  36 TH√ÅNG: ${plans[36] ? plans[36].thang + " | L√£i: " + plans[36].lai : ""}<br>

  <br>
  <b>TH·ª¶ T·ª§C:</b> CCCD CHIP + ƒêTDƒê
`;

        document.body.appendChild(exportDiv);

        const canvas = await html2canvas(exportDiv, {
          scale: 2,
          useCORS: true,
        });
        const imgData = canvas.toDataURL("image/png");

        const { jsPDF } = window.jspdf;

        // ‚úÖ A6 size (A4 chia 4)
        const pdf = new jsPDF({
          orientation: "portrait",
          unit: "mm",
          format: [105, 148],
        });

        pdf.addImage(imgData, "PNG", 0, 0, 105, 148);
        pdf.save("bang-tra-gop-hdsaison.pdf");

        document.body.removeChild(exportDiv);

        bootstrap.Modal.getInstance(
          document.getElementById("exportModal"),
        ).hide();
      }

      window.onload = () => {
        if (sessionStorage.getItem("logged") === "1")
          $("loginScreen").style.display = "none";
        renderPackageButtons();
      };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
