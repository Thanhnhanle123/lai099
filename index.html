<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C√¥ng c·ª• HD SaiSon</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
        font-family: Roboto;
      }
      body {
        background: #f0f4f8;
        padding-top: 56px;
      }

      /* LOGIN */
      #loginScreen {
        position: fixed;
        inset: 0;
        background: linear-gradient(135deg, #007bff, #00c6ff);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      .login-box {
        background: #fff;
        padding: 30px;
        width: 320px;
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
        text-align: center;
      }

      /* HEADER */
      header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 56px;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        z-index: 1000;
      }
      .logo {
        font-weight: 700;
        color: #007bff;
      }
      .desktop-nav a {
        margin-left: 15px;
        text-decoration: none;
        color: #333;
      }
      @media (max-width: 768px) {
        .desktop-nav {
          display: none;
        }
      }

      /* CONTENT */
      .container-custom {
        max-width: 520px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }
      label {
        font-weight: 500;
      }
      input {
        text-align: right;
        font-size: 16px;
        padding: 12px;
      }

      .result {
        margin-top: 20px;
        padding: 15px;
        background: #e7f3ff;
        border-left: 5px solid #007bff;
        border-radius: 12px;
      }
      .plan-box {
        background: #fff;
        border-radius: 14px;
        padding: 14px;
        margin-bottom: 12px;
        border: 1px solid #e3eaf3;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: relative;
        cursor: pointer;
        transition: 0.25s;
      }
      .plan-row {
        display: flex;
        justify-content: space-between;
        font-size: 14px;
      }
      .plan-row .value {
        font-weight: 600;
        color: #0d47a1;
      }
      .plan-row.total .value {
        color: #e53935;
        font-weight: 700;
      }
      .divider {
        height: 1px;
        background: #e0e0e0;
        margin: 8px 0;
      }

      /* BEST PLAN */
      .best-plan {
        border: 2px solid #2e7d32 !important;
        background: #e8f5e9;
      }
      .best-plan::before {
        content: "üí∞ R·∫∫ NH·∫§T";
        position: absolute;
        top: -10px;
        right: 10px;
        background: #2e7d32;
        color: #fff;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
      }

      /* CLICK HIGHLIGHT */
      .plan-box.active {
        border: 3px solid #ff9800 !important;
        background: #fff3e0;
        box-shadow: 0 6px 18px rgba(255, 152, 0, 0.4);
      }
      .plan-box.active::after {
        content: "üëâ KH√ÅCH CH·ªåN";
        position: absolute;
        top: -10px;
        left: 10px;
        background: #ff9800;
        color: #fff;
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 12px;
      }
      .list-group button {
        font-size: 14px;
        text-align: left;
      }
    </style>
  </head>

  <body>
    <!-- LOGIN -->
    <div id="loginScreen">
      <div class="login-box">
        <h4>üîê ƒêƒÉng nh·∫≠p</h4>
        <input
          id="loginKey"
          type="password"
          class="form-control mb-3"
          placeholder="Nh·∫≠p kho√°"
        />
        <button class="btn btn-primary w-100" onclick="login()">
          X√°c nh·∫≠n
        </button>
        <p id="loginError" class="text-danger mt-2"></p>
      </div>
    </div>

    <!-- ===== HEADER ===== -->
    <header>
      <div class="logo">üöó Batch 41</div>

      <!-- DESKTOP NAV -->
      <nav class="desktop-nav">
        <a href="index.html">T√≠nh tr·∫£ g√≥p</a>
        <a href="check_old.html">T√≠nh tu·ªïi</a>
        <a href="cancel_contract.html">Hu·ª∑ Hƒê</a>
        <a href="#" onclick="logout()">ƒêƒÉng xu·∫•t</a>
      </nav>

      <!-- HAMBURGER -->
      <button
        class="btn btn-outline-primary d-md-none"
        data-bs-toggle="offcanvas"
        data-bs-target="#mobileMenu"
      >
        ‚ò∞
      </button>
    </header>

    <!-- ===== MOBILE MENU ===== -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="mobileMenu">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">üöó Batch 41</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="offcanvas"
        ></button>
      </div>
      <div class="offcanvas-body">
        <a class="btn btn-light w-100 mb-2" href="index.html"
          >üìä T√≠nh tr·∫£ g√≥p</a
        >
        <a class="btn btn-light w-100 mb-2" href="check_old.html"
          >üéÇ T√≠nh tu·ªïi</a
        >
        <a class="btn btn-light w-100 mb-2" href="cancel_contract.html"
          >‚ùå Hu·ª∑ h·ª£p ƒë·ªìng</a
        >
        <hr />
        <button class="btn btn-danger w-100" onclick="logout()">
          üîê ƒêƒÉng xu·∫•t
        </button>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="container-custom mt-3">
      <h5 class="text-center">T√çNH TR·∫¢ G√ìP XE</h5>

      <label>Gi√° xe</label>
      <input id="giaXe" class="form-control mb-3" oninput="onGiaXeChange()" />
      <div id="suggestGiaXe" class="list-group mb-2"></div>

      <label>Tr·∫£ tr∆∞·ªõc (VNƒê)</label>
      <input
        id="traTien"
        class="form-control mb-3"
        oninput="onTraTienChange()"
      />

      <label>Tr·∫£ tr∆∞·ªõc (%)</label>
      <input
        id="traPercent"
        class="form-control mb-2"
        oninput="onTraPercentChange()"
      />

      <div class="d-flex gap-2 mb-3">
        <button
          class="btn btn-outline-secondary w-100"
          onclick="setPercent(20)"
        >
          20%
        </button>
        <button
          class="btn btn-outline-secondary w-100"
          onclick="setPercent(30)"
        >
          30%
        </button>
        <button
          class="btn btn-outline-secondary w-100"
          onclick="setPercent(40)"
        >
          40%
        </button>
      </div>

      <div class="d-flex gap-2 mb-3">
        <!-- <button id="btn099" class="btn btn-primary w-100" onclick="setPackage(0.99)">0.99</button> -->
        <button
          id="btn089"
          class="btn btn-primary w-100"
          onclick="setPackage(0.89)"
        >
          0.89
        </button>
        <button
          id="btn121"
          class="btn btn-secondary w-100"
          onclick="setPackage(1.21)"
        >
          MC1_1.21
        </button>
        <button
          id="btn151"
          class="btn btn-secondary w-100"
          onclick="setPackage(1.51)"
        >
          MC2_1.51
        </button>
        <!-- <button id="btn121" class="btn btn-secondary w-100" onclick="setPackage(1.21)">1.21</button> -->
        <!-- <button
          id="btn166"
          class="btn btn-secondary w-100"
          onclick="setPackage(1.66)"
        >
          1.66
        </button> -->
      </div>

      <div id="result" class="result" style="display: none"></div>

      <button class="btn btn-warning w-100 mt-2" onclick="exportImage()">
        üì∏ Xu·∫•t ·∫£nh g·ª≠i Zalo
      </button>
    </div>

    <script>
      const ACCESS_KEY = "B41";
      function login() {
        loginKey.value === ACCESS_KEY
          ? ((loginScreen.style.display = "none"),
            sessionStorage.setItem("logged", "1"))
          : (loginError.innerText = "Sai kho√°");
      }
      function logout() {
        sessionStorage.clear();
        location.reload();
      }
      window.onload = () => {
        if (sessionStorage.getItem("logged") === "1")
          loginScreen.style.display = "none";
      };

      // const heSo99={9:0.126179,12:0.098233,15:0.081497,18:0.070365,21:0.06244,24:0.05651,36:0.042809};
      const heSo089 = {
        9: 0.12517,
        12: 0.09723,
        15: 0.08049,
        18: 0.06936,
        21: 0.06143,
        24: 0.05548,
      };
      const heSo121 = {
        9: 0.12837,
        12: 0.1004,
        15: 0.08367,
        18: 0.07256,
        21: 0.06465,
        24: 0.05874,
        36: 0.04516,
      };
      const heSo151 = {
        9: 0.131461,
        12: 0.103484,
        15: 0.086765,
        18: 0.075684,
        21: 0.067811,
        24: 0.061945,
        36: 0.048559,
      };
      // 0,131461	0,103484	0,086765	0,075684	0,067811	0,061945	0,053845	0,048559
      // const heSo166 = { 18: 0.07719, 21: 0.069355, 24: 0.063512, 36: 0.050251 };

      // let currentPackage=0.99,lock=false;
      let currentPackage = 1.21,
        lock = false;

      const format = (n) => n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      const parse = (v) => parseFloat(v.replace(/\./g, "")) || 0;
      const ceil = (n) => Math.ceil(n / 1000) * 1000;
      const formatInput = (el) =>
        (el.value = format(el.value.replace(/\D/g, "")));

      function setPercent(p) {
        traPercent.value = p;
        onTraPercentChange();
      }
      function setPackage(p) {
        currentPackage = p;
        // btn099.className=p===0.99?"btn btn-primary w-100":"btn btn-secondary w-100";
        btn089.className =
          p === 0.89 ? "btn btn-primary w-100" : "btn btn-secondary w-100";
        btn121.className =
          p === 1.21 ? "btn btn-primary w-100" : "btn btn-secondary w-100";
        btn151.className =
          p === 1.51 ? "btn btn-primary w-100" : "btn btn-secondary w-100";
        // btn166.className =
        //   p === 1.66 ? "btn btn-primary w-100" : "btn btn-secondary w-100";
        autoTinh();
      }
      function genSuggestions(raw) {
        let n = parseFloat(raw.replace(/\D/g, "")) || 0;
        if (n <= 0) return [];

        return [n * 1000, n * 10000, n * 1000000];
      }

      function onGiaXeSuggest() {
        let raw = giaXe.value;
        let box = suggestGiaXe;
        box.innerHTML = "";

        let list = genSuggestions(raw);
        if (list.length === 0) return;

        list.forEach((v) => {
          let btn = document.createElement("button");
          btn.className = "list-group-item list-group-item-action";
          btn.innerText = format(v.toString()) + " ƒë";
          btn.onclick = () => {
            giaXe.value = format(v.toString());
            box.innerHTML = "";
            autoTinh();
          };
          box.appendChild(btn);
        });
      }

      function onGiaXeChange() {
        formatInput(giaXe);
        autoTinh();
        onGiaXeSuggest();
      }
      function onTraTienChange() {
        if (lock) return;
        lock = true;
        formatInput(traTien);
        if (parse(giaXe.value) > 0)
          traPercent.value = (
            (parse(traTien.value) / parse(giaXe.value)) *
            100
          ).toFixed(2);
        lock = false;
        let box = suggestGiaXe;
        box.innerHTML = "";
        autoTinh();
      }
      function onTraPercentChange() {
        if (lock) return;
        lock = true;
        traTien.value = format(
          ceil((parse(giaXe.value) * parseFloat(traPercent.value || 0)) / 100),
        );
        lock = false;
        let box = suggestGiaXe;
        box.innerHTML = "";
        autoTinh();
      }

      function autoTinh() {
        if (parse(giaXe.value) > 0 && parse(traTien.value) < parse(giaXe.value))
          tinhTraGop();
        else result.style.display = "none";
      }

      function tinhTraGop() {
        const vay = parse(giaXe.value) - parse(traTien.value);
        // const heSo=currentPackage===0.99?heSo99:currentPackage===0.89?heSo089:heSo166;
        let heSo;

        switch (currentPackage) {
          case 1.21:
            heSo = heSo121;
            break;

          case 0.89:
            heSo = heSo089;
            break;
          
          // case 1.51:
          //   heSo = heSo151;
          //   break;

          default:
            heSo = heSo151;
        }

        let min = Infinity,
          plans = [];
        for (let t in heSo) {
          const thang = ceil(vay * heSo[t] + 12000);
          const lai = thang * t - vay;
          if (lai < min) min = lai;
          plans.push({ t, thang, lai });
        }

        let html = `<b>Gi√° xe:</b> ${format(giaXe.value)} ƒë<br>
            <b>Tr·∫£ tr∆∞·ªõc:</b> ${format(traTien.value)} ƒë<br>
            <b>Kho·∫£n vay:</b> ${format(vay)} ƒë<br><br>`;
        plans.forEach((p) => {
          html += `
    <div class="plan-box ${p.lai === min ? "best-plan" : ""}" onclick="selectPlan(this)">
      <div class="plan-row"><strong>${p.t} th√°ng</strong></div>
      <div class="plan-row"><span>Tr·∫£/th√°ng</span><span class="value">${format(p.thang)} ƒë</span></div>
      <div class="divider"></div>
      <div class="plan-row total"><span>T·ªïng l√£i</span><span class="value">${format(p.lai)} ƒë</span></div>
    </div>`;
        });

        result.innerHTML = html;
        result.style.display = "block";
      }

      function selectPlan(el) {
        document
          .querySelectorAll(".plan-box")
          .forEach((p) => p.classList.remove("active"));
        el.classList.add("active");
      }

      function exportImage() {
        if (result.style.display === "none") return alert("Ch∆∞a c√≥ d·ªØ li·ªáu");
        html2canvas(result).then((c) => {
          const a = document.createElement("a");
          a.href = c.toDataURL();
          a.download = "bang-tra-gop-hdsaison.png";
          a.click();
        });
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
